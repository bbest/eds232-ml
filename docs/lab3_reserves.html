<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Jeffrey O. Hanson" />

<meta name="date" content="2021-09-26" />

<title>Lab 3. Reserve Planning</title>

<script src="site_libs/header-attrs-2.11/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>




<style type="text/css">
/* for pandoc --citeproc since 2.11 */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="files/prioritizr-style.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Labs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="lab1a_sdm-explore.html">1a. Species: explore</a>
    </li>
    <li>
      <a href="lab1b_sdm-regress.html">1b. Species: regress</a>
    </li>
    <li>
      <a href="lab1c_sdm-trees.html">1c. Species: trees</a>
    </li>
    <li>
      <a href="lab1d_sdm-evaluate.html">1d. Species: evaluate</a>
    </li>
    <li>
      <a href="lab2a_community-cluster.html">2a. Community: cluster</a>
    </li>
    <li>
      <a href="lab2b_community-ordination.html">2b. Community: ordination</a>
    </li>
  </ul>
</li>
<li>
  <a href="glossary.html">Glosssary</a>
</li>
<li>
  <a href="resources.html">Resources</a>
</li>
<li>
  <a href="https://github.com/bbest/eds232-ml">
    <span class="fab fa-github"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Lab 3. Reserve Planning</h1>
<h4 class="author">Jeffrey O. Hanson</h4>
<h4 class="date">2021-09-26</h4>

</div>


<div id="learning-objectives" class="section level1 unnumbered">
<h1 class="unnumbered">Learning Objectives</h1>
</div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This lab was created by the developer of the R package <a href="https://prioritizr.net/"><code>prioritizr</code></a> Jeffrey O. Hanson. I made slight tweaks to streamline code and reduce text.</p>
<p>You open this Rmarkdown document from taylor.bren.ucsb.edu at <code>/Courses/EDS232/eds232-ml/lab3_reserves.Rmd</code>, save to your home folder and respond to questions within the Rmarkdown document before knitting to complete the lab.</p>
<div id="overview" class="section level2">
<h2>Overview</h2>
<p>The aim of this lab is to get you started with using the prioritizr R package for systematic conservation planning. It is not designed to give you a comprehensive overview and you will not become an expert after completing this workshop. Instead, we want to help you understand the core principles of conservation planning and guide you through some of the common tasks involved with developing prioritizations. In other words, we want to give you the knowledge base and confidence needed to start applying systematic conservation planning to your own work.</p>
</div>
<div id="r-packages" class="section level2">
<h2>R packages</h2>
<p>An R package is a collection of R code and documentation that can be installed to enhance the standard R environment with additional functionality. Currently, there are over fifteen thousand R packages available on CRAN. Each of these R packages are developed to perform a specific task, such as <a href="https://cran.r-project.org/web/packages/readxl/index.html">reading Excel spreadsheets</a>, <a href="https://cran.r-project.org/web/packages/MODIStsp/index.html">downloading satellite imagery data</a>, <a href="https://cran.r-project.org/web/packages/wdpar/index.html">downloading and cleaning protected area data</a>, or <a href="https://cran.r-project.org/web/packages/ENMeval/index.html">fitting environmental niche models</a>. In fact, R has such a diverse ecosystem of R packages, that the question is almost always not “can I use R to …?” but “what R package can I use to …?” During this workshop, we will use several R packages. To install and load these R packages, please enter the code below in the <em>Console</em> part of the RStudio interface and press enter. Note that you will require an Internet connection and the installation process may take some time to complete.</p>
<pre class="r"><code>if (!require(&quot;librarian&quot;)){
  install.packages(&quot;librarian&quot;)
  library(librarian)
}
librarian::shelf(
  assertthat, BiocManager, dplyr, gridExtra, here, mapview, 
  prioritizr, prioritizrdata, 
  raster, remotes, rgeos, rgdal, scales, sf, sp, stringr,
  units)</code></pre>
<pre><code>## 
##   The &#39;cran_repo&#39; argument in shelf() was not set, so it will use
##   cran_repo = &#39;https://cran.r-project.org&#39; by default.
## 
##   To avoid this message, set the &#39;cran_repo&#39; argument to a CRAN
##   mirror URL (see https://cran.r-project.org/mirrors.html) or set
##   &#39;quiet = TRUE&#39;.</code></pre>
<pre class="r"><code>if (!require(&quot;lpsymphony&quot;)){
  BiocManager::install(&quot;lpsymphony&quot;)
  library(lpsymphony)
}</code></pre>
</div>
<div id="data-setup" class="section level2">
<h2>Data Setup</h2>
<p>The data for this workshop are available online. The code chunk below handles downloading the data from <a href="https://github.com/prioritizr/massey-workshop/raw/main/data.zip">here</a>, saving it as <code>data.zip</code>, unzippig the <code>data.zip</code> file and moving files into <code>dir_data</code>. You should now have a new folder on your computer called <code>"data/prioritizr"</code> which contains the data files (e.g. <code>pu.shp</code> and <code>vegetation.tif</code>).</p>
<pre class="r"><code>dir_data &lt;- here(&quot;data/prioritizr&quot;)
pu_shp   &lt;- file.path(dir_data, &quot;pu.shp&quot;)
pu_url   &lt;- &quot;https://github.com/prioritizr/massey-workshop/raw/main/data.zip&quot;
pu_zip   &lt;- file.path(dir_data, basename(pu_url))
vegetation_tif &lt;- file.path(dir_data, &quot;vegetation.tif&quot;)

dir.create(dir_data, showWarnings = F, recursive = T)
if (!file.exists(pu_shp)){
  download.file(pu_url, pu_zip)
  unzip(pu_zip, exdir = dir_data)
  dir_unzip   &lt;- file.path(dir_data, &quot;data&quot;)
  files_unzip &lt;- list.files(dir_unzip, full.names = T)
  file.rename(
    files_unzip, 
    files_unzip %&gt;% str_replace(&quot;prioritizr/data&quot;, &quot;prioritizr&quot;))
  unlink(c(pu_zip, dir_unzip), recursive = T)
}</code></pre>
</div>
</div>
<div id="data" class="section level1">
<h1>Data</h1>
<div id="data-import" class="section level2">
<h2>Data import</h2>
<p>Now that we have the downloaded dataset, we will need to import it into our R session. Specifically, this data was obtained from the “Introduction to Marxan” course and was originally a subset of a larger spatial prioritization project performed under contract to Australia’s Department of Environment and Water Resources. It contains vector-based planning unit data (<code>pu.shp</code>) and the raster-based data describing the spatial distributions of 32 vegetation classes (<code>vegetation.tif</code>) in southern Tasmania, Australia. Please note this dataset is only provided for teaching purposes and should not be used for any real-world conservation planning. We can import the data into our R session using the following code.</p>
<pre class="r"><code># import planning unit data
pu_data &lt;- as(read_sf(pu_shp), &quot;Spatial&quot;)

# format columns in planning unit data
pu_data$locked_in &lt;- as.logical(pu_data$locked_in)
pu_data$locked_out &lt;- as.logical(pu_data$locked_out)

# import vegetation data
veg_data &lt;- stack(vegetation_tif)</code></pre>
</div>
<div id="planning-unit-data" class="section level2">
<h2>Planning unit data</h2>
<p>The planning unit data contains spatial data describing the geometry for each planning unit and attribute data with information about each planning unit (e.g. cost values). Let’s investigate the <code>pu_data</code> object. The attribute data contains 5 columns with contain the following information:</p>
<ul>
<li><code>id</code>: unique identifiers for each planning unit</li>
<li><code>cost</code>: acquisition cost values for each planning unit (millions of Australian dollars).</li>
<li><code>status</code>: status information for each planning unit (only relevant with Marxan)</li>
<li><code>locked_in</code>: logical values (i.e. <code>TRUE</code>/<code>FALSE</code>) indicating if planning units are covered by protected areas or not.</li>
<li><code>locked_out</code>: logical values (i.e. <code>TRUE</code>/<code>FALSE</code>) indicating if planning units cannot be managed as a protected area because they contain are too degraded.</li>
</ul>
<pre class="r"><code># print a short summary of the data
print(pu_data)</code></pre>
<pre><code>## class       : SpatialPolygonsDataFrame 
## features    : 516 
## extent      : 348703.2, 611932.4, 5167775, 5344516  (xmin, xmax, ymin, ymax)
## crs         : +proj=utm +zone=55 +south +datum=WGS84 +units=m +no_defs 
## variables   : 5
## names       :   id,             cost, status, locked_in, locked_out 
## min values  :  557, 3.59717531470679,      0,         0,          0 
## max values  : 1130,  47.238336402701,      2,         1,          1</code></pre>
<pre class="r"><code># plot the planning unit data
plot(pu_data)</code></pre>
<p><img src="lab3_reserves_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<pre class="r"><code># plot an interactive map of the planning unit data
mapview(pu_data)</code></pre>
<pre class="r"><code># print the structure of object
str(pu_data, max.level = 2)</code></pre>
<pre><code>## Formal class &#39;SpatialPolygonsDataFrame&#39; [package &quot;sp&quot;] with 5 slots
##   ..@ data       :&#39;data.frame&#39;:  516 obs. of  5 variables:
##   ..@ polygons   :List of 516
##   ..@ plotOrder  : int [1:516] 69 104 1 122 157 190 4 221 17 140 ...
##   ..@ bbox       : num [1:2, 1:2] 348703 5167775 611932 5344516
##   .. ..- attr(*, &quot;dimnames&quot;)=List of 2
##   ..@ proj4string:Formal class &#39;CRS&#39; [package &quot;sp&quot;] with 1 slot
##   ..$ comment: chr &quot;TRUE&quot;</code></pre>
<pre class="r"><code># print the class of the object
class(pu_data)</code></pre>
<pre><code>## [1] &quot;SpatialPolygonsDataFrame&quot;
## attr(,&quot;package&quot;)
## [1] &quot;sp&quot;</code></pre>
<pre class="r"><code># print the slots of the object
slotNames(pu_data)</code></pre>
<pre><code>## [1] &quot;data&quot;        &quot;polygons&quot;    &quot;plotOrder&quot;   &quot;bbox&quot;        &quot;proj4string&quot;</code></pre>
<pre class="r"><code># print the coordinate reference system
print(pu_data@proj4string)</code></pre>
<pre><code>## CRS arguments:
##  +proj=utm +zone=55 +south +datum=WGS84 +units=m +no_defs</code></pre>
<pre class="r"><code># print number of planning units (geometries) in the data
nrow(pu_data)</code></pre>
<pre><code>## [1] 516</code></pre>
<pre class="r"><code># print the first six rows in the data
head(pu_data@data)</code></pre>
<pre><code>##    id     cost status locked_in locked_out
## 1 557 29.74225      0     FALSE      FALSE
## 2 558 29.87703      0     FALSE      FALSE
## 3 574 28.60687      0     FALSE      FALSE
## 4 575 30.83416      0     FALSE      FALSE
## 5 576 38.75511      0     FALSE      FALSE
## 6 577 38.11618      2      TRUE      FALSE</code></pre>
<pre class="r"><code># print the first six values in the cost column of the attribute data
head(pu_data$cost)</code></pre>
<pre><code>## [1] 29.74225 29.87703 28.60687 30.83416 38.75511 38.11618</code></pre>
<pre class="r"><code># print the highest cost value
max(pu_data$cost)</code></pre>
<pre><code>## [1] 47.23834</code></pre>
<pre class="r"><code># print the smallest cost value
min(pu_data$cost)</code></pre>
<pre><code>## [1] 3.597175</code></pre>
<pre class="r"><code># print average cost value
mean(pu_data$cost)</code></pre>
<pre><code>## [1] 26.87393</code></pre>
<pre class="r"><code># plot a map of the planning unit cost data
spplot(pu_data, &quot;cost&quot;)</code></pre>
<p><img src="lab3_reserves_files/figure-html/unnamed-chunk-9-1.png" width="60%" /></p>
<pre class="r"><code># plot an interactive map of the planning unit cost data
mapview(pu_data, zcol = &quot;cost&quot;)</code></pre>
<p>Now, you can try and answer some questions about the planning unit data.</p>

<div class="rmdquestion">
<ol style="list-style-type: decimal">
<li>How many planning units are in the planning unit data?</li>
<li>What is the highest cost value?</li>
<li>Is there a spatial pattern in the planning unit cost values (hint: use <code>plot</code> to make a map)?
</div></li>
</ol>
</div>
<div id="vegetation-data" class="section level2">
<h2>Vegetation data</h2>
<p>The vegetation data describe the spatial distribution of 32 vegetation classes in the study area. This data is in a raster format and so the data are organized using a grid comprising square grid cells that are each the same size. In our case, the raster data contains multiple layers (also called “bands”) and each layer has corresponds to a spatial grid with exactly the same area and has exactly the same dimensionality (i.e. number of rows, columns, and cells). In this dataset, there are 32 different regular spatial grids layered on top of each other – with each layer corresponding to a different vegetation class – and each of these layers contains a grid with 164 rows, 326 columns, and 53464 cells. Within each layer, each cell corresponds to a 0.967 by 1.02 km square. The values associated with each grid cell indicate the (one) presence or (zero) absence of a given vegetation class in the cell.</p>
<p><img src="img/lab3_prioritizr/rasterbands.png" /></p>
<p>Let’s explore the vegetation data.</p>
<pre class="r"><code># print a short summary of the data
print(veg_data)</code></pre>
<pre><code>## class      : RasterStack 
## dimensions : 164, 326, 53464, 32  (nrow, ncol, ncell, nlayers)
## resolution : 967, 1020  (x, y)
## extent     : 298636.7, 613878.7, 5167756, 5335036  (xmin, xmax, ymin, ymax)
## crs        : +proj=utm +zone=55 +south +datum=WGS84 +units=m +no_defs 
## names      : vegetation.1, vegetation.2, vegetation.3, vegetation.4, vegetation.5, vegetation.6, vegetation.7, vegetation.8, vegetation.9, vegetation.10, vegetation.11, vegetation.12, vegetation.13, vegetation.14, vegetation.15, ... 
## min values :            0,            0,            0,            0,            0,            0,            0,            0,            0,             0,             0,             0,             0,             0,             0, ... 
## max values :            1,            1,            1,            1,            1,            1,            1,            1,            1,             1,             1,             1,             1,             1,             1, ...</code></pre>
<pre class="r"><code># plot a map of the 20th vegetation class
plot(veg_data[[20]])</code></pre>
<p><img src="lab3_reserves_files/figure-html/explore%20feature%20data-1.png" width="672" /></p>
<pre class="r"><code># plot an interactive map of the 20th vegetation class
mapview(veg_data[[20]])</code></pre>
<pre class="r"><code># print number of rows in the data
nrow(veg_data)</code></pre>
<pre><code>## [1] 164</code></pre>
<pre class="r"><code># print number of columns  in the data
ncol(veg_data)</code></pre>
<pre><code>## [1] 326</code></pre>
<pre class="r"><code># print number of cells in the data
ncell(veg_data)</code></pre>
<pre><code>## [1] 53464</code></pre>
<pre class="r"><code># print number of layers in the data
nlayers(veg_data)</code></pre>
<pre><code>## [1] 32</code></pre>
<pre class="r"><code># print  resolution on the x-axis
xres(veg_data)</code></pre>
<pre><code>## [1] 967</code></pre>
<pre class="r"><code># print resolution on the y-axis
yres(veg_data)</code></pre>
<pre><code>## [1] 1020</code></pre>
<pre class="r"><code># print spatial extent of the grid, i.e. coordinates for corners
extent(veg_data)</code></pre>
<pre><code>## class      : Extent 
## xmin       : 298636.7 
## xmax       : 613878.7 
## ymin       : 5167756 
## ymax       : 5335036</code></pre>
<pre class="r"><code># print the coordinate reference system
print(veg_data@crs)</code></pre>
<pre><code>## CRS arguments:
##  +proj=utm +zone=55 +south +datum=WGS84 +units=m +no_defs</code></pre>
<pre class="r"><code># print a summary of the first layer in the stack
print(veg_data[[1]])</code></pre>
<pre><code>## class      : RasterLayer 
## band       : 1  (of  32  bands)
## dimensions : 164, 326, 53464  (nrow, ncol, ncell)
## resolution : 967, 1020  (x, y)
## extent     : 298636.7, 613878.7, 5167756, 5335036  (xmin, xmax, ymin, ymax)
## crs        : +proj=utm +zone=55 +south +datum=WGS84 +units=m +no_defs 
## source     : vegetation.tif 
## names      : vegetation.1 
## values     : 0, 1  (min, max)</code></pre>
<pre class="r"><code># print the value in the 800th cell in the first layer of the stack
print(veg_data[[1]][800])</code></pre>
<pre><code>##   
## 0</code></pre>
<pre class="r"><code># print the value of the cell located in the 30th row and the 60th column of
# the first layer
print(veg_data[[1]][30, 60])</code></pre>
<pre><code>##   
## 0</code></pre>
<pre class="r"><code># calculate the sum of all the cell values in the first layer
cellStats(veg_data[[1]], &quot;sum&quot;)</code></pre>
<pre><code>## [1] 17</code></pre>
<pre class="r"><code># calculate the maximum value of all the cell values in the first layer
cellStats(veg_data[[1]], &quot;max&quot;)</code></pre>
<pre><code>## [1] 1</code></pre>
<pre class="r"><code># calculate the minimum value of all the cell values in the first layer
cellStats(veg_data[[1]], &quot;min&quot;)</code></pre>
<pre><code>## [1] 0</code></pre>
<pre class="r"><code># calculate the mean value of all the cell values in the first layer
cellStats(veg_data[[1]], &quot;mean&quot;)</code></pre>
<pre><code>## [1] 0.00035239</code></pre>
<p>Now, you can try and answer some questions about the vegetation data.</p>

<div class="rmdquestion">
<ol style="list-style-type: decimal">
<li>What part of the study area is the 13th vegetation class found in (hint: make a map)? For instance, is it in the south-eastern part of the study area?</li>
<li>What proportion of cells contain the 12th vegetation class?</li>
<li>Which vegetation class is the most abundant (i.e. present in the greatest number of cells)?
</div></li>
</ol>
</div>
</div>
<div id="gap-analysis" class="section level1">
<h1>Gap analysis</h1>
<div id="introduction-1" class="section level2">
<h2>Introduction</h2>
<p>Before we begin to prioritize areas for protected area establishment, we should first understand how well existing protected areas are conserving our biodiversity features (i.e. native vegetation classes in Tasmania, Australia). This step is critical: we cannot develop plans to improve conservation of biodiversity if we don’t understand how well existing policies are currently conserving biodiversity! To achieve this, we can perform a “gap analysis.” A gap analysis involves calculating how well each of our biodiversity features (i.e. vegetation classes in this exercise) are represented (covered) by protected areas. Next, we compare current representation by protected areas of each feature (e.g. 5% of their spatial distribution covered by protected areas) to a target threshold (e.g. 20% of their spatial distribution covered by protected areas). This target threshold denotes the minimum amount (e.g. minimum proportion of spatial distribution) that we need of each feature to be represented in the protected area system. Ideally, targets should be based on an estimate of how much area or habitat is needed for ecosystem function or species persistence. In practice, targets are generally set using simple rules of thumb (e.g. 10% or 20%), policy (17%; <a href="https://www.cbd.int/sp/targets/rationale/target-11" class="uri">https://www.cbd.int/sp/targets/rationale/target-11</a>) or standard practices (e.g. setting targets for species based on geographic range size) <span class="citation">(Butchart et al. 2015; Rodrigues et al. 2004)</span>.</p>
</div>
<div id="feature-abundance" class="section level2">
<h2>Feature abundance</h2>
<p>Now we will perform some preliminary calculations to explore the data. First, we will calculate how much of each vegetation feature occurs inside each planning unit (i.e. the abundance of the features). To achieve this, we will use the <code>problem</code> function to create an empty conservation planning problem that only contains the planning unit and biodiversity data. We will then use the <code>feature_abundances</code> function to calculate the total amount of each feature in each planning unit.</p>
<pre class="r"><code># create prioritizr problem with only the data
p0 &lt;- problem(pu_data, veg_data, cost_column = &quot;cost&quot;)

# print empty problem,
# we can see that only the cost and feature data are defined
print(p0)</code></pre>
<pre><code>## Conservation Problem
##   planning units: SpatialPolygonsDataFrame (516 units)
##   cost:           min: 3.59718, max: 47.23834
##   features:       vegetation.1, vegetation.2, vegetation.3, ... (32 features)
##   objective:      none
##   targets:        none
##   decisions:      default
##   constraints:    &lt;none&gt;
##   penalties:      &lt;none&gt;
##   portfolio:      default
##   solver:         default</code></pre>
<pre class="r"><code># calculate amount of each feature in each planning unit
abundance_data &lt;- feature_abundances(p0)

# print abundance data
print(abundance_data)</code></pre>
<pre><code>## # A tibble: 32 × 3
##    feature       absolute_abundance relative_abundance
##    &lt;chr&gt;                      &lt;dbl&gt;              &lt;dbl&gt;
##  1 vegetation.1                16.0                  1
##  2 vegetation.2                14.3                  1
##  3 vegetation.3                10.4                  1
##  4 vegetation.4                17.8                  1
##  5 vegetation.5                13.0                  1
##  6 vegetation.6                14.3                  1
##  7 vegetation.7                20.0                  1
##  8 vegetation.8                14.0                  1
##  9 vegetation.9                18.0                  1
## 10 vegetation.10               20.0                  1
## # … with 22 more rows</code></pre>
<pre class="r"><code># note that only the first ten rows are printed,
# this is because the abundance_data object is a tibble (i.e. tbl_df) object
# and not a standard data.frame object
print(class(abundance_data))</code></pre>
<pre><code>## [1] &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;</code></pre>
<pre class="r"><code># we can print all of the rows in abundance_data like this
print(abundance_data, n = Inf)</code></pre>
<pre><code>## # A tibble: 32 × 3
##    feature       absolute_abundance relative_abundance
##    &lt;chr&gt;                      &lt;dbl&gt;              &lt;dbl&gt;
##  1 vegetation.1                16.0                  1
##  2 vegetation.2                14.3                  1
##  3 vegetation.3                10.4                  1
##  4 vegetation.4                17.8                  1
##  5 vegetation.5                13.0                  1
##  6 vegetation.6                14.3                  1
##  7 vegetation.7                20.0                  1
##  8 vegetation.8                14.0                  1
##  9 vegetation.9                18.0                  1
## 10 vegetation.10               20.0                  1
## 11 vegetation.11               23.6                  1
## 12 vegetation.12              748.                   1
## 13 vegetation.13              126.                   1
## 14 vegetation.14               10.5                  1
## 15 vegetation.15               17.5                  1
## 16 vegetation.16               15.0                  1
## 17 vegetation.17              213.                   1
## 18 vegetation.18               14.3                  1
## 19 vegetation.19               17.1                  1
## 20 vegetation.20               21.4                  1
## 21 vegetation.21               18.6                  1
## 22 vegetation.22              297.                   1
## 23 vegetation.23               20.3                  1
## 24 vegetation.24              165.                   1
## 25 vegetation.25              716.                   1
## 26 vegetation.26               24.0                  1
## 27 vegetation.27               18.8                  1
## 28 vegetation.28               17.5                  1
## 29 vegetation.29               24.7                  1
## 30 vegetation.30               59.0                  1
## 31 vegetation.31               60.0                  1
## 32 vegetation.32               32                    1</code></pre>
<p>The <code>abundance_data</code> object contains three columns. The <code>feature</code> column contains the name of each feature (derived from <code>names(veg_data)</code>), the <code>absolute_abundance</code> column contains the total amount of each feature in all the planning units, and the <code>relative_abundance</code> column contains the total amount of each feature in the planning units expressed as a proportion of the total amount in the underlying raster data. Since all the raster cells containing vegetation overlap with the planning units, all of the values in the <code>relative_abundance</code> column are equal to one (meaning 100%). Now let’s add a new column with the feature abundances expressed in area units (i.e. km<sup>2</sup>).</p>
<pre class="r"><code># add new column with feature abundances in km^2
abundance_data$absolute_abundance_km2 &lt;-
  (abundance_data$absolute_abundance * prod(res(veg_data))) %&gt;%
  set_units(m^2) %&gt;%
  set_units(km^2)

# print abundance data
print(abundance_data)</code></pre>
<pre><code>## # A tibble: 32 × 4
##    feature       absolute_abundance relative_abundance absolute_abundance_km2
##    &lt;chr&gt;                      &lt;dbl&gt;              &lt;dbl&gt;                 [km^2]
##  1 vegetation.1                16.0                  1                   15.8
##  2 vegetation.2                14.3                  1                   14.1
##  3 vegetation.3                10.4                  1                   10.2
##  4 vegetation.4                17.8                  1                   17.6
##  5 vegetation.5                13.0                  1                   12.8
##  6 vegetation.6                14.3                  1                   14.1
##  7 vegetation.7                20.0                  1                   19.7
##  8 vegetation.8                14.0                  1                   13.9
##  9 vegetation.9                18.0                  1                   17.8
## 10 vegetation.10               20.0                  1                   19.7
## # … with 22 more rows</code></pre>
<p>Now let’s explore the abundance data.</p>
<pre class="r"><code># calculate the average abundance of the features
mean(abundance_data$absolute_abundance_km2)</code></pre>
<pre><code>## 86.82948 [km^2]</code></pre>
<pre class="r"><code># plot histogram of the features&#39; abundances
hist(abundance_data$absolute_abundance_km2, main = &quot;Feature abundances&quot;)</code></pre>
<p><img src="lab3_reserves_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<pre class="r"><code># find the abundance of the feature with the largest abundance
max(abundance_data$absolute_abundance_km2)</code></pre>
<pre><code>## 737.982 [km^2]</code></pre>
<pre class="r"><code># find the name of the feature with the largest abundance
abundance_data$feature[which.max(abundance_data$absolute_abundance_km2)]</code></pre>
<pre><code>## [1] &quot;vegetation.12&quot;</code></pre>
<p>Now, try to answer the following questions.</p>

<div class="rmdquestion">
<ol style="list-style-type: decimal">
<li>What is the median abundance of the features (hint: <code>median</code>)?</li>
<li>What is the name of the feature with smallest abundance?</li>
<li>How many features have a total abundance greater than 100 km^2 (hint: use <code>sum(abundance_data$absolute_abundance_km2 &gt; set_units(threshold, km^2)</code> with the correct <code>threshold</code> value)?</li>
</ol>
</div>
</div>
<div id="feature-representation" class="section level2">
<h2>Feature representation</h2>
<p>After calculating the total amount of each feature in the planning units (i.e. the features’ abundances), we will now calculate the amount of each feature in the planning units that are covered by protected areas (i.e. feature representation by protected areas). We can complete this task using the <code>eval_feature_representation_summary()</code> function. This function requires (i) a conservation problem object with the planning unit and biodiversity data and also (ii) an object representing a solution to the problem (i.e an object in the same format as the planning unit data with values indicating if the planning units are selected or not).</p>
<pre class="r"><code># create column in planning unit data with binary values (zeros and ones)
# indicating if a planning unit is covered by protected areas or not
pu_data$pa_status &lt;- as.numeric(pu_data$locked_in)

# calculate feature representation by protected areas
repr_data &lt;- eval_feature_representation_summary(p0, pu_data[, &quot;pa_status&quot;])

# print feature representation data
print(repr_data)</code></pre>
<pre><code>## # A tibble: 32 × 5
##    summary feature       total_amount absolute_held relative_held
##    &lt;chr&gt;   &lt;chr&gt;                &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;
##  1 overall vegetation.1          16.0         0            0     
##  2 overall vegetation.2          14.3         0            0     
##  3 overall vegetation.3          10.4         0            0     
##  4 overall vegetation.4          17.8         0            0     
##  5 overall vegetation.5          13.0         0            0     
##  6 overall vegetation.6          14.3         0            0     
##  7 overall vegetation.7          20.0         0            0     
##  8 overall vegetation.8          14.0         0            0     
##  9 overall vegetation.9          18.0         0.846        0.0470
## 10 overall vegetation.10         20.0         0            0     
## # … with 22 more rows</code></pre>
<p>Similar to the abundance data before, the <code>repr_data</code> object contains three columns. The <code>feature</code> column contains the name of each feature, the <code>absolute_held</code> column shows the total amount of each feature held in the solution (i.e. the planning units covered by protected areas), and the <code>relative_held</code> column shows the proportion of each feature held in the solution (i.e. the proportion of each feature’s spatial distribution held in protected areas). Since the <code>absolute_held</code> values correspond to the number of grid cells in the <code>veg_data</code> object with overlap with protected areas, let’s convert them to area units (i.e. km<sup>2</sup>) so we can report them.</p>
<pre class="r"><code># add new column with the areas represented in km^2
repr_data$absolute_held_km2 &lt;-
  (repr_data$absolute_held * prod(res(veg_data))) %&gt;%
  set_units(m^2) %&gt;%
  set_units(km^2)

# print representation data
print(repr_data)</code></pre>
<pre><code>## # A tibble: 32 × 6
##    summary feature     total_amount absolute_held relative_held absolute_held_k…
##    &lt;chr&gt;   &lt;chr&gt;              &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;           [km^2]
##  1 overall vegetation…         16.0         0            0                 0    
##  2 overall vegetation…         14.3         0            0                 0    
##  3 overall vegetation…         10.4         0            0                 0    
##  4 overall vegetation…         17.8         0            0                 0    
##  5 overall vegetation…         13.0         0            0                 0    
##  6 overall vegetation…         14.3         0            0                 0    
##  7 overall vegetation…         20.0         0            0                 0    
##  8 overall vegetation…         14.0         0            0                 0    
##  9 overall vegetation…         18.0         0.846        0.0470            0.834
## 10 overall vegetation…         20.0         0            0                 0    
## # … with 22 more rows</code></pre>
<p>Now let’s investigate how well the species are represented.</p>

<div class="rmdquestion">
<ol style="list-style-type: decimal">
<li>What is the average proportion of the features held in protected areas (hint: use <code>mean(table$relative_held)</code> with the correct <code>table</code> name)?</li>
<li>If we set a target of 10% coverage by protected areas, how many features fail to meet this target (hint: use <code>sum(table$relative_held &gt;= target_value)</code> with the correct <code>table</code> name)?</li>
<li>If we set a target of 20% coverage by protected areas, how many features fail to meet this target?</li>
<li>Is there a relationship between the total abundance of a feature and how well it is represented by protected areas (hint: <code>plot(abundance_data$absolute_abundance ~ repr_data$relative_held)</code>)?</li>
</ol>
</div>
</div>
</div>
<div id="spatial-prioritizations" class="section level1">
<h1>Spatial prioritizations</h1>
<div id="introduction-2" class="section level2">
<h2>Introduction</h2>
<p>Here we will develop prioritizations to identify priority areas for protected area establishment. Its worth noting that prioritizr is a decision support tool (similar to <a href="http://marxan.org/">Marxan</a> and <a href="https://www.helsinki.fi/en/researchgroups/digital-geography-lab/software-developed-in-cbig#section-52992">Zonation</a>). This means that it is designed to help you make decisions—it can’t make decisions for you.</p>
</div>
<div id="starting-out-simple" class="section level2">
<h2>Starting out simple</h2>
<p>To start things off, let’s keep things simple. Let’s create a prioritization using the <a href="https://prioritizr.net/reference/add_min_set_objective.html">minimum set formulation of the reserve selection problem</a>. This formulation means that we want a solution that will meet the targets for our biodiversity features for minimum cost. Here, we will set 5% targets for each vegetation class and use the data in the <code>cost</code> column to specify acquisition costs. Although we strongly recommend using <a href="https://www.gurobi.com/">Gurobi</a> to solve problems (with <a href="https://prioritizr.net/reference/add_gurobi_solver.html"><code>add_gurobi_solver</code></a>), we will use the <a href="https://prioritizr.net/reference/add_lpsymphony_solver.html">lpsymphony solver</a> in this workshop since it is easier to install. The Gurobi solver is much faster than the lpsymphony solver (<a href="https://prioritizr.net/articles/gurobi_installation.html">see here for installation instructions</a>).</p>
<pre class="r"><code># print planning unit data
print(pu_data)</code></pre>
<pre><code>## class       : SpatialPolygonsDataFrame 
## features    : 516 
## extent      : 348703.2, 611932.4, 5167775, 5344516  (xmin, xmax, ymin, ymax)
## crs         : +proj=utm +zone=55 +south +datum=WGS84 +units=m +no_defs 
## variables   : 6
## names       :   id,             cost, status, locked_in, locked_out, pa_status 
## min values  :  557, 3.59717531470679,      0,         0,          0,         0 
## max values  : 1130,  47.238336402701,      2,         1,          1,         1</code></pre>
<pre class="r"><code># make prioritization problem
p1_rds &lt;- file.path(dir_data, &quot;p1.rds&quot;)
if (!file.exists(p1_rds)){
  p1 &lt;- problem(pu_data, veg_data, cost_column = &quot;cost&quot;) %&gt;%
        add_min_set_objective() %&gt;%
        add_relative_targets(0.05) %&gt;% # 5% representation targets
        add_binary_decisions() %&gt;%
        add_lpsymphony_solver()
  saveRDS(p1, p1_rds)
}
p1 &lt;- readRDS(p1_rds)

# print problem
print(p1)</code></pre>
<pre><code>## Conservation Problem
##   planning units: SpatialPolygonsDataFrame (516 units)
##   cost:           min: 3.59718, max: 47.23834
##   features:       vegetation.1, vegetation.2, vegetation.3, ... (32 features)
##   objective:      Minimum set objective 
##   targets:        Relative targets [targets (min: 0.05, max: 0.05)]
##   decisions:      Binary decision 
##   constraints:    &lt;none&gt;
##   penalties:      &lt;none&gt;
##   portfolio:      default
##   solver:         Lpsymphony [first_feasible (0), gap (0.1), time_limit (2147483647), verbose (1)]</code></pre>
<pre class="r"><code># solve problem
s1 &lt;- solve(p1)

# print solution, the solution_1 column contains the solution values
# indicating if a planning unit is (1) selected or (0) not
print(s1)</code></pre>
<pre><code>## class       : SpatialPolygonsDataFrame 
## features    : 516 
## extent      : 348703.2, 611932.4, 5167775, 5344516  (xmin, xmax, ymin, ymax)
## crs         : +proj=utm +zone=55 +south +datum=WGS84 +units=m +no_defs 
## variables   : 7
## names       :   id,             cost, status, locked_in, locked_out, pa_status, solution_1 
## min values  :  557, 3.59717531470679,      0,         0,          0,         0,          0 
## max values  : 1130,  47.238336402701,      2,         1,          1,         1,          1</code></pre>
<pre class="r"><code># calculate number of planning units selected in the prioritization
eval_n_summary(p1, s1[, &quot;solution_1&quot;])</code></pre>
<pre><code>## # A tibble: 1 × 2
##   summary  cost
##   &lt;chr&gt;   &lt;dbl&gt;
## 1 overall    15</code></pre>
<pre class="r"><code># calculate total cost of the prioritization
eval_cost_summary(p1, s1[, &quot;solution_1&quot;])</code></pre>
<pre><code>## # A tibble: 1 × 2
##   summary  cost
##   &lt;chr&gt;   &lt;dbl&gt;
## 1 overall  385.</code></pre>
<pre class="r"><code># plot solution
# selected = green, not selected = grey
spplot(s1, &quot;solution_1&quot;, col.regions = c(&quot;grey80&quot;, &quot;darkgreen&quot;), main = &quot;s1&quot;,
       colorkey = FALSE)</code></pre>
<p><img src="lab3_reserves_files/figure-html/unnamed-chunk-23-1.png" width="65%" /></p>
<p>Now let’s examine the solution.</p>

<div class="rmdquestion">
<ol style="list-style-type: decimal">
<li>How many planing units were selected in the prioritization? What proportion of planning units were selected in the prioritization?</li>
<li>Is there a pattern in the spatial distribution of the priority areas?</li>
<li>Can you verify that all of the targets were met in the prioritization (hint: <code>eval_feature_representation_summary(p1, s1[, "solution_1"])</code>)?</li>
</ol>
</div>
</div>
<div id="adding-complexity" class="section level2">
<h2>Adding complexity</h2>
<p>Our first prioritization suffers many limitations, so let’s add additional constraints to the problem to make it more useful. First, let’s lock in planing units that are already by covered protected areas. If some vegetation communities are already secured inside existing protected areas, then we might not need to add as many new protected areas to the existing protected area system to meet their targets. Since our planning unit data (<code>pu_da</code>) already contains this information in the <code>locked_in</code> column, we can use this column name to specify which planning units should be locked in.</p>
<pre class="r"><code># plot locked_in data
# TRUE = blue, FALSE = grey
spplot(pu_data, &quot;locked_in&quot;, col.regions = c(&quot;grey80&quot;, &quot;darkblue&quot;),
       main = &quot;locked_in&quot;, colorkey = FALSE)</code></pre>
<p><img src="lab3_reserves_files/figure-html/unnamed-chunk-25-1.png" width="65%" /></p>
<pre class="r"><code># make prioritization problem
p2_rds &lt;- file.path(dir_data, &quot;p2.rds&quot;)
if (!file.exists(p2_rds)){
  p2 &lt;- problem(pu_data, veg_data, cost_column = &quot;cost&quot;) %&gt;%
      add_min_set_objective() %&gt;%
      add_relative_targets(0.05) %&gt;%
      add_locked_in_constraints(&quot;locked_in&quot;) %&gt;%
      add_binary_decisions() %&gt;%
      add_lpsymphony_solver()
  saveRDS(p2, p2_rds)
}
p2 &lt;- readRDS(p2_rds)

# print problem
print(p2)</code></pre>
<pre><code>## Conservation Problem
##   planning units: SpatialPolygonsDataFrame (516 units)
##   cost:           min: 3.59718, max: 47.23834
##   features:       vegetation.1, vegetation.2, vegetation.3, ... (32 features)
##   objective:      Minimum set objective 
##   targets:        Relative targets [targets (min: 0.05, max: 0.05)]
##   decisions:      Binary decision 
##   constraints:    &lt;Locked in planning units [198 locked units]&gt;
##   penalties:      &lt;none&gt;
##   portfolio:      default
##   solver:         Lpsymphony [first_feasible (0), gap (0.1), time_limit (2147483647), verbose (1)]</code></pre>
<pre class="r"><code># solve problem
s2 &lt;- solve(p2)

# plot solution
# selected = green, not selected = grey
spplot(s2, &quot;solution_1&quot;, col.regions = c(&quot;grey80&quot;, &quot;darkgreen&quot;), main = &quot;s2&quot;,
       colorkey = FALSE)</code></pre>
<p><img src="lab3_reserves_files/figure-html/unnamed-chunk-26-1.png" width="65%" /></p>
<p>Let’s pretend that we talked to an expert on the vegetation communities in our study system and they recommended that a 10% target was needed for each vegetation class. So, equipped with this information, let’s set the targets to 10%.</p>
<pre class="r"><code># make prioritization problem
p3_rds &lt;- file.path(dir_data, &quot;p3.rds&quot;)
if (!file.exists(p3_rds)){
  p3 &lt;- problem(pu_data, veg_data, cost_column = &quot;cost&quot;) %&gt;%
    add_min_set_objective() %&gt;%
    add_relative_targets(0.1) %&gt;%
    add_locked_in_constraints(&quot;locked_in&quot;) %&gt;%
    add_binary_decisions() %&gt;%
    add_lpsymphony_solver()
  saveRDS(p3, p3_rds)
}
p3 &lt;- readRDS(p3_rds)

# print problem
print(p3)</code></pre>
<pre><code>## Conservation Problem
##   planning units: SpatialPolygonsDataFrame (516 units)
##   cost:           min: 3.59718, max: 47.23834
##   features:       vegetation.1, vegetation.2, vegetation.3, ... (32 features)
##   objective:      Minimum set objective 
##   targets:        Relative targets [targets (min: 0.1, max: 0.1)]
##   decisions:      Binary decision 
##   constraints:    &lt;Locked in planning units [198 locked units]&gt;
##   penalties:      &lt;none&gt;
##   portfolio:      default
##   solver:         Lpsymphony [first_feasible (0), gap (0.1), time_limit (2147483647), verbose (1)]</code></pre>
<pre class="r"><code># solve problem
s3 &lt;- solve(p3)

# plot solution
# selected = green, not selected = grey
spplot(s3, &quot;solution_1&quot;, col.regions = c(&quot;grey80&quot;, &quot;darkgreen&quot;), main = &quot;s3&quot;,
       colorkey = FALSE)</code></pre>
<p><img src="lab3_reserves_files/figure-html/unnamed-chunk-27-1.png" width="65%" /></p>
<p>Next, let’s lock out highly degraded areas. Similar to before, this information is present in our planning unit data so we can use the <code>locked_out</code> column name to achieve this.</p>
<pre class="r"><code># plot locked_out data
# TRUE = red, FALSE = grey
spplot(pu_data, &quot;locked_out&quot;, col.regions = c(&quot;grey80&quot;, &quot;darkred&quot;),
       main = &quot;locked_out&quot;, colorkey = FALSE)</code></pre>
<p><img src="lab3_reserves_files/figure-html/unnamed-chunk-28-1.png" width="65%" /></p>
<pre class="r"><code># make prioritization problem
p4_rds &lt;- file.path(dir_data, &quot;p4.rds&quot;)
if (!file.exists(p4_rds)){
  p4 &lt;- problem(pu_data, veg_data, cost_column = &quot;cost&quot;) %&gt;%
    add_min_set_objective() %&gt;%
    add_relative_targets(0.1) %&gt;%
    add_locked_in_constraints(&quot;locked_in&quot;) %&gt;%
    add_locked_out_constraints(&quot;locked_out&quot;) %&gt;%
    add_binary_decisions() %&gt;%
    add_lpsymphony_solver()
  saveRDS(p4, p4_rds)
}
p4 &lt;- readRDS(p4_rds)</code></pre>
<pre class="r"><code># print problem
print(p4)</code></pre>
<pre><code>## Conservation Problem
##   planning units: SpatialPolygonsDataFrame (516 units)
##   cost:           min: 3.59718, max: 47.23834
##   features:       vegetation.1, vegetation.2, vegetation.3, ... (32 features)
##   objective:      Minimum set objective 
##   targets:        Relative targets [targets (min: 0.1, max: 0.1)]
##   decisions:      Binary decision 
##   constraints:    &lt;Locked out planning units [6 locked units]
##                    Locked in planning units [198 locked units]&gt;
##   penalties:      &lt;none&gt;
##   portfolio:      default
##   solver:         Lpsymphony [first_feasible (0), gap (0.1), time_limit (2147483647), verbose (1)]</code></pre>
<pre class="r"><code># solve problem
s4 &lt;- solve(p4)

# plot solution
# selected = green, not selected = grey
spplot(s4, &quot;solution_1&quot;, col.regions = c(&quot;grey80&quot;, &quot;darkgreen&quot;), main = &quot;s4&quot;,
       colorkey = FALSE)</code></pre>
<p><img src="lab3_reserves_files/figure-html/unnamed-chunk-29-1.png" width="65%" /></p>
<p>Now, let’s compare the solutions.</p>

<div class="rmdquestion">
<ol style="list-style-type: decimal">
<li>What is the cost of the planning units selected in <code>s2</code>, <code>s3</code>, and <code>s4</code>?</li>
<li>How many planning units are in <code>s2</code>, <code>s3</code>, and <code>s4</code>?</li>
<li>Do the solutions with more planning units have a greater cost? Why (or why not)?</li>
<li>Why does the first solution (<code>s1</code>) cost less than the second solution with protected areas locked into the solution (<code>s2</code>)?</li>
<li>Why does the third solution (<code>s3</code>) cost less than the fourth solution solution with highly degraded areas locked out (<code>s4</code>)?</li>
</ol>
</div>
</div>
<div id="penalizing-fragmentation" class="section level2">
<h2>Penalizing fragmentation</h2>
<p>Plans for protected area systems should promote connectivity. However, the prioritizations we have made so far have been highly fragmented. To address this issue, we can add penalties to our conservation planning problem to penalize fragmentation. These penalties work by specifying a trade-off between the primary objective (here, solution cost) and fragmentation (i.e. total exposed boundary length) using a penalty value. If we set the penalty value too low, then we will end up with a solution that is nearly identical to the previous solution. If we set the penalty value too high, then prioritizr will (1) take a long time to solve the problem and (2) we will end up with a solution that contains lots of extra planning units that are not needed. This is because the minimizing fragmentation is considered so much more important than solution cost that the optimal solution is simply to select as many planning units as possible.</p>
<p>As a rule of thumb, we generally want penalty values between 0.00001 and 0.01. However, finding a useful penalty value requires calibration. The “correct” penalty value depends on the size of the planning units, the main objective values (e.g. cost values), and the effect of fragmentation on biodiversity persistence. Let’s create a new problem that is similar to our previous problem (<code>p4</code>)—except that it contains boundary length penalties—and solve it. Since our planning unit data is in a spatial format (i.e. vector or raster data), prioritizr can automatically calculate the boundary data for us.</p>
<pre class="r"><code># make prioritization problem
p5_rds &lt;- file.path(dir_data, &quot;p5.rds&quot;)
if (!file.exists(p5_rds)){
  p5 &lt;- problem(pu_data, veg_data, cost_column = &quot;cost&quot;) %&gt;%
    add_min_set_objective() %&gt;%
    add_boundary_penalties(penalty = 0.001) %&gt;%
    add_relative_targets(0.1) %&gt;%
    add_locked_in_constraints(&quot;locked_in&quot;) %&gt;%
    add_locked_out_constraints(&quot;locked_out&quot;) %&gt;%
    add_binary_decisions() %&gt;%
    add_lpsymphony_solver()
  saveRDS(p5, p5_rds)
}
p5 &lt;- readRDS(p5_rds)

# print problem
print(p5)</code></pre>
<pre><code>## Conservation Problem
##   planning units: SpatialPolygonsDataFrame (516 units)
##   cost:           min: 3.59718, max: 47.23834
##   features:       vegetation.1, vegetation.2, vegetation.3, ... (32 features)
##   objective:      Minimum set objective 
##   targets:        Relative targets [targets (min: 0.1, max: 0.1)]
##   decisions:      Binary decision 
##   constraints:    &lt;Locked in planning units [198 locked units]
##                    Locked out planning units [6 locked units]&gt;
##   penalties:      &lt;Boundary penalties [edge factor (min: 0.5, max: 0.5), penalty (0.001), zones]&gt;
##   portfolio:      default
##   solver:         Lpsymphony [first_feasible (0), gap (0.1), time_limit (2147483647), verbose (1)]</code></pre>
<pre class="r"><code># solve problem,
# note this will take a bit longer than the previous runs
s5 &lt;- solve(p5)

# print solution
print(s5)</code></pre>
<pre><code>## class       : SpatialPolygonsDataFrame 
## features    : 516 
## extent      : 348703.2, 611932.4, 5167775, 5344516  (xmin, xmax, ymin, ymax)
## crs         : +proj=utm +zone=55 +south +datum=WGS84 +units=m +no_defs 
## variables   : 7
## names       :   id,             cost, status, locked_in, locked_out, pa_status, solution_1 
## min values  :  557, 3.59717531470679,      0,         0,          0,         0,          0 
## max values  : 1130,  47.238336402701,      2,         1,          1,         1,          1</code></pre>
<pre class="r"><code># plot solution
# selected = green, not selected = grey
spplot(s5, &quot;solution_1&quot;, col.regions = c(&quot;grey80&quot;, &quot;darkgreen&quot;), main = &quot;s5&quot;,
       colorkey = FALSE)</code></pre>
<p><img src="lab3_reserves_files/figure-html/unnamed-chunk-32-1.png" width="65%" /></p>
<p>Now let’s compare the solutions to the problems with (<code>s5</code>) and without (<code>s4</code>) the boundary length penalties.</p>

<div class="rmdquestion">
<ol style="list-style-type: decimal">
<li>What is the cost the fourth (<code>s4</code>) and fifth (<code>s5</code>) solutions? Why does the fifth solution (<code>s5</code>) cost more than the fourth (<code>s4</code>) solution?</li>
<li>Try setting the penalty value to 0.000000001 (i.e. <code>1e-9</code>) instead of 0.001. What is the cost of the solution now? Is it different from the fourth solution (<code>s4</code>) (hint: try plotting the solutions to visualize them)? Is this is a useful penalty value? Why (or why not)?</li>
<li>Try setting the penalty value to 0.5. What is the cost of the solution now? Is it different from the fourth solution (<code>s4</code>) (hint: try plotting the solutions to visualize them)? Is this a useful penalty value? Why (or why not)?</li>
</ol>
</div>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-r1" class="csl-entry">
Butchart, Stuart H. M., Martin Clarke, Robert J. Smith, Rachel E. Sykes, Jörn P. W. Scharlemann, Mike Harfoot, Graeme M. Buchanan, et al. 2015. <span>“Shortfalls and Solutions for Meeting National and Global Conservation Area Targets.”</span> <em>Conservation Letters</em> 8 (5): 329–37.
</div>
<div id="ref-r2" class="csl-entry">
Rodrigues, Ana S. L., H. Resit Akçakaya, Sandy J. Andelman, Mohamed I. Bakarr, Luigi Boitani, Thomas M. Brooks, Janice S. Chanson, et al. 2004. <span>“Global Gap Analysis: Priority Regions for Expanding the Global Protected-Area Network.”</span> <em>BioScience</em> 54 (12): 1092–1100.
</div>
</div>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
